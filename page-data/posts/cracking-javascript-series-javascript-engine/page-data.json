{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/cracking-javascript-series-javascript-engine","result":{"data":{"markdownRemark":{"id":"ee5316c6-8e2c-52bb-9ad1-2608a00fb93b","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74f1593e765ce853960c4c5b7b897fb8/25e07/javascript-engine-execution-steps.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDAv/EABYBAQEBAAAAAAAAAAAAAAAAAAMAAf/aAAwDAQACEAMQAAABrJNiiaLf/8QAGRABAAMBAQAAAAAAAAAAAAAAAQACERIi/9oACAEBAAEFAj0WrhBcVzpn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABcQAAMBAAAAAAAAAAAAAAAAAAARMSD/2gAIAQEABj8Co8U//8QAGxABAAICAwAAAAAAAAAAAAAAAQARECExYYH/2gAIAQEAAT8hTy6egg7F4NQY6ix82if/2gAMAwEAAgADAAAAEGDP/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/EBxn/8QAFhEBAQEAAAAAAAAAAAAAAAAAACFh/9oACAECAQE/EMK//8QAHBABAAICAwEAAAAAAAAAAAAAAQARIVEQMUGB/9oACAEBAAE/EEmG4QuHyOguBPA1ROhBTwj6F0KNE//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/74f1593e765ce853960c4c5b7b897fb8/8ac56/javascript-engine-execution-steps.webp 240w,\n/static/74f1593e765ce853960c4c5b7b897fb8/d3be9/javascript-engine-execution-steps.webp 480w,\n/static/74f1593e765ce853960c4c5b7b897fb8/e46b2/javascript-engine-execution-steps.webp 960w,\n/static/74f1593e765ce853960c4c5b7b897fb8/f992d/javascript-engine-execution-steps.webp 1440w,\n/static/74f1593e765ce853960c4c5b7b897fb8/882b9/javascript-engine-execution-steps.webp 1920w,\n/static/74f1593e765ce853960c4c5b7b897fb8/b8f0e/javascript-engine-execution-steps.webp 3358w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/74f1593e765ce853960c4c5b7b897fb8/09b79/javascript-engine-execution-steps.jpg 240w,\n/static/74f1593e765ce853960c4c5b7b897fb8/7cc5e/javascript-engine-execution-steps.jpg 480w,\n/static/74f1593e765ce853960c4c5b7b897fb8/6a068/javascript-engine-execution-steps.jpg 960w,\n/static/74f1593e765ce853960c4c5b7b897fb8/644c5/javascript-engine-execution-steps.jpg 1440w,\n/static/74f1593e765ce853960c4c5b7b897fb8/0f98f/javascript-engine-execution-steps.jpg 1920w,\n/static/74f1593e765ce853960c4c5b7b897fb8/25e07/javascript-engine-execution-steps.jpg 3358w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/74f1593e765ce853960c4c5b7b897fb8/6a068/javascript-engine-execution-steps.jpg\"\n            alt=\"javascript engine execution steps\"\n            title=\"javascript engine execution steps\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"history\" style=\"position:relative;\"><a href=\"#history\" aria-label=\"history permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>History</h3>\n<ul>\n<li>The first JavaScript Engine was created by <a href=\"https://zh.wikipedia.org/wiki/%E5%B8%83%E8%98%AD%E7%99%BB%C2%B7%E8%89%BE%E5%85%8B\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Brendan Eich</a> in 1995 for the Netscape Navigator web browser. It called <a href=\"https://zh.wikipedia.org/wiki/SpiderMonkey\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">“SpiderMonkey”</a> which is still used by the Firefox browser now.</li>\n<li>V8 Engine (Wrote in C++) was developed by Google in 2008 because of building faster browser engine in order to control people to use their search engine. However, there is not only one JavaScript Engine in the world.</li>\n</ul>\n<h3 id=\"ast-abstract-syntax-tree\" style=\"position:relative;\"><a href=\"#ast-abstract-syntax-tree\" aria-label=\"ast abstract syntax tree permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AST (Abstract Syntax Tree)</h3>\n<p>The word “Parser” mentioned above actually could break down in three steps below.</p>\n<p><img src=\"https://i.imgur.com/kvJujij.png\"></p>\n<p>Fortunately, we don’t need to go through all its phases, converting HHL (High-level language) code to bits. We are interested in Lexical and Syntax Analysis only. These two steps play the main role in generating AST from code.</p>\n<ul>\n<li>\n<p>Lexical analyzer (a.k.a. scanner)</p>\n<p>First step. Lexical analyzer, also called scanner, it reads a stream of characters (our code) and combines them into tokens using defined rules. Also, it will remove white space characters, comments, etc. In the end, the entire string of code will be split into a list of tokens.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token number\">42</span>\n\n<span class=\"token comment\">// -------\\&lt;lexical analyzer\\>-------></span>\n\n<span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'identifier'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">'var'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'whitespace'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">' '</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>    \n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'identifier'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'whitespace'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">' '</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'operator'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">'='</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'whitespace'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">' '</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'num'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">'42'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'sep'</span><span class=\"token punctuation\">,</span>value<span class=\"token operator\">:</span><span class=\"token string\">';'</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p><img src=\"https://i.imgur.com/hefucSh.jpg\"></p>\n<p>When the lexical analyzer read the source-code, it scans the code letter by letter; and when it encounters a whitespace, operator symbol, or special symbols, it decides that a word is completed.</p>\n</li>\n<li>\n<p>Syntax analyzer （parser）</p>\n<p>Second step. Syntax analyzer, also called parser, will take a plain list of tokens after Lexical Analysis and turn it into a tree representation, validating language syntax and throwing syntax errors, if such happened.</p>\n<p><img src=\"https://i.imgur.com/eaCICbS.png\"></p>\n<p>While generating a tree, some parsers omit unnecessary tokens (like redundant brackets for example) so they create ‘Abstract Syntax Tree’ — it is not 100% of code match, but enough to know how to deal with it. On another hand, parsers which fully cover all code structure generate tree called ‘Concrete Syntax Tree’.</p>\n<p>You can use <a href=\"https://astexplorer.net/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AST explorer</a> to see how a parser converts JavaScript into a syntax tree.</p>\n</li>\n</ul>\n<h3 id=\"interpreter--compiler\" style=\"position:relative;\"><a href=\"#interpreter--compiler\" aria-label=\"interpreter  compiler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Interpreter &#x26; Compiler</h3>\n<ul>\n<li>\n<p><a href=\"https://en.wikipedia.org/wiki/Interpreter_(computing)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Interpreter (From Wiki)</a></p>\n<blockquote>\n<p>In computer science, an interpreter is a computer program that directly executes, i.e. performs, instructions written in a programming or scripting language, without previously compiling them into a machine language program.</p>\n</blockquote>\n<ul>\n<li>\n<p>Pros (Take JavaScript as an example.)</p>\n<p>An interpreter is able to interpret JS directly and run as fast as it can.</p>\n</li>\n<li>\n<p>Cons</p>\n<p>The more JS code is written, the slower running speed it can be. Without compiler, when you are running redundant code like the same code in a for loop, it will execute them over and over again, even though the result of the loop gives the same.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// With interpreter</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">sumCalulation</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token punctuation\">,</span> y</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*** \n     * With only interpreter, the code will be running 1000 times,\n     * though the result would always be 9.\n    ***/</span>\n    <span class=\"token function\">sumCalulation</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://en.wikipedia.org/wiki/Compiler\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Compiler (From Wiki)</a></p>\n<blockquote>\n<p>The name compiler is primarily used for programs that translate source code from a high-level programming language to a lower level language (e.g., assembly language, object code, or machine code) to create an executable program.</p>\n</blockquote>\n<ul>\n<li>\n<p>Pros</p>\n<p>The compiler will do optimization with the source code.</p>\n</li>\n<li>\n<p>Cons</p>\n<p>The compiler takes a little bit longer to get up and to run.</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token comment\">// With compiler</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">sumCalulation</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token punctuation\">,</span> y</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// sumCalulation(5,4); it can be replace with 9</span>\n        <span class=\"token number\">9</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<blockquote>\n<p>🤔 <strong>Self-question</strong>\n<br>Is there a way we can get the best of both?</p>\n</blockquote>\n<ul>\n<li>\n<p>Jit Compiler (Just-in-time compilation)</p>\n<p><img src=\"https://i.imgur.com/NXZcd2t.png\">\n<em>In 2017-06-05, Google launched the Ignition+TurboFan pipeline in Chrome 59</em></p>\n<p><img src=\"https://i.imgur.com/byH4LW8.png\"></p>\n<ul>\n<li>\n<p><a href=\"https://v8.dev/docs/ignition\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ignition</a> (Interpreter)</p>\n<blockquote>\n<p>V8 features an interpreter called Ignition. Ignition is a fast low-level register-based interpreter written using the backend of TurboFan, and it’s designed for reducing memory cost in a mobile device. Because in the past, Full-Codegen doesn’t really apply any serious optimizations (it was supposed to generate code as quickly as possible), it was used to taking 30% of the managed memory in typical web applications was used by Code objects.</p>\n</blockquote>\n</li>\n<li>\n<p><a href=\"https://v8.dev/docs/turbofan\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">TurboFan</a> (Compilers)</p>\n<blockquote>\n<p>Replace Crankshaft with TurboFan which is based on <a href=\"https://darksi.de/d.sea-of-nodes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sea-of-nodes</a> architecture. It’s designed for solving <a href=\"https://benediktmeurer.de/2017/03/01/v8-behind-the-scenes-february-edition\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Performance Cliffs</a>, and become more adaptable to add new ECMAScript function in the future.</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://i.imgur.com/TerwGMr.png\"></p>\n<blockquote>\n<p>🤔 <strong>Self-question</strong>\n<br>Is JavaScript an interpreted language?</p>\n</blockquote>\n<h3 id=\"optimized-code\" style=\"position:relative;\"><a href=\"#optimized-code\" aria-label=\"optimized code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimized Code</h3>\n<ul>\n<li>\n<p><a href=\"https://richardartoul.github.io/jekyll/update/2015/04/26/hidden-classes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hidden Class</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token number\">1</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Point</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token punctuation\">,</span>y</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">2</span>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span>\n<span class=\"token number\">3</span>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> y<span class=\"token punctuation\">;</span>\n<span class=\"token number\">4</span>  <span class=\"token punctuation\">}</span>\n<span class=\"token number\">5</span>\n<span class=\"token number\">6</span>  <span class=\"token keyword\">var</span> obj1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Point</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">7</span>  <span class=\"token keyword\">var</span> obj2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Point</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">8</span>\n<span class=\"token number\">9</span>  obj1<span class=\"token punctuation\">.</span>a <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">10</span> obj1<span class=\"token punctuation\">.</span>b <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">11</span>\n<span class=\"token number\">12</span> obj2<span class=\"token punctuation\">.</span>b <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">13</span> obj2<span class=\"token punctuation\">.</span>a <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n</ul>\n<p>Up until line 8, <code class=\"language-text\">obj1</code> and <code class=\"language-text\">obj2</code> shared the same hidden class. However, since properties a and b were added in opposite orders, <code class=\"language-text\">obj1</code> and <code class=\"language-text\">obj2</code> end up with different hidden classes as a result of following separate transition paths.</p>\n<p>ps: Because JavaScript is a dynamic language, we are able to add new properties without define them in constructure previously, and the engine will create hidden class to deal with it during run time.</p>\n<p><img src=\"https://i.imgur.com/yOMGnvY.jpg\"></p>\n<p>If you’ve been following along closely, your first instinct might be to think that obj1 and obj2 having two different hidden classes isn’t a big deal. As long as each of their hidden classes stores the appropriate offsets, accessing their properties should be just as fast as if they shared a hidden class right?</p>\n<p>In order to understand why this isn’t true, we need to take a look at another optimization technique employed by V8 called inline caching.</p>\n<ul>\n<li>\n<p><a href=\"https://github.com/sq/JSIL/wiki/Optimizing-dynamic-JavaScript-with-inline-caches\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Inline Cache</a></p>\n<p>Whenever a method is called on a specific object, the V8 engine has to perform a lookup to that objects hidden class to determine the offset for accessing a specific property. After two successful calls of the same method to the same hidden class, V8 omits the hidden class lookup and simply adds the offset of the property to the object pointer itself. For all future calls of that method, the V8 engine assumes that the hidden class hasn’t changed, and jumps directly into the memory address for a specific property using the offsets stored from previous lookups; this greatly increases execution speed.</p>\n</li>\n</ul>\n<p><img src=\"https://i.imgur.com/ftYBlzp.jpg\"></p>\n<blockquote>\n<p>🤔 <strong>Self-question</strong>\n<br>Why not just use machine code from the beginning? So they don’t have to worry about interpreter, compiler, JIT compliler stuff</p>\n</blockquote>\n<h3 id=\"webassembly\" style=\"position:relative;\"><a href=\"#webassembly\" aria-label=\"webassembly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://webassembly.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WebAssembly</a></h3>\n<p>Nowadays, browsers still have different ways of doing things like JS engine, but what if there is a standard binary executable format? Here comes “WebAssembly”.</p>\n<p><img src=\"https://i.imgur.com/1ZEO5Yv.png\"></p>\n<h3 id=\"call-stack--memory-heap\" style=\"position:relative;\"><a href=\"#call-stack--memory-heap\" aria-label=\"call stack  memory heap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Call Stack &#x26; Memory Heap</h3>\n<ul>\n<li>\n<h4 id=\"call-stack-first-in-last-out-mode\" style=\"position:relative;\"><a href=\"#call-stack-first-in-last-out-mode\" aria-label=\"call stack first in last out mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Call Stack (First in last out mode)</h4>\n<p>Call Stack mainly is to keep track of the point to which each active subroutine should return control when it finishes executing.</p>\n</li>\n<li>\n<h4 id=\"memory-heap\" style=\"position:relative;\"><a href=\"#memory-heap\" aria-label=\"memory heap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Memory Heap</h4>\n<p>As a place to allocate memory, use memory, and release memory</p>\n<p><img src=\"https://i.imgur.com/n3DX5ap.png\"></p>\n<p>Call stack now has the anonymous function which was the global execution context. When running the <code class=\"language-text\">calculate()</code> function, it’s just added on the top of the stack.</p>\n<p><img src=\"https://i.imgur.com/fWiOrq9.jpg\"></p>\n</li>\n<li>\n<h4 id=\"stack-overflow\" style=\"position:relative;\"><a href=\"#stack-overflow\" aria-label=\"stack overflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stack Overflow</h4>\n<p><img src=\"https://i.imgur.com/dadXXGw.png\"></p>\n<p>It’s caused when a program writes more data to a buffer located on the stack than what is actually allocated for that buffer. It usually happened in infinite recursion function, or just because of too many stacks are put.</p>\n</li>\n<li>\n<h4 id=\"memory-leaks\" style=\"position:relative;\"><a href=\"#memory-leaks\" aria-label=\"memory leaks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Memory Leaks</h4>\n<p>It’s a type of resource leak that occurs when a computer program incorrectly manages memory allocations[1] in such a way that memory which is no longer needed is not released.</p>\n<p><img src=\"https://i.imgur.com/jePtv9a.png\"></p>\n<p>The garbage collection wasn’t really working because we had this array we were using this array over and over until we crashed our program.</p>\n<p>Three typically reasons cause memory leaks:</p>\n<ul>\n<li>\n<p>Global variable</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> b <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> c <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span></code></pre></div>\n</li>\n<li>\n<p>Event listeners</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nelement<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> onclick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// You have better unregister the event listener when things are done.</span></code></pre></div>\n</li>\n<li>\n<p>SetInterval</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// You have better unregister the event listener when things are done.</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<h4 id=\"garbage-collection\" style=\"position:relative;\"><a href=\"#garbage-collection\" aria-label=\"garbage collection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Garbage Collection</h4>\n<ul>\n<li><a href=\"https://liujiacai.net/blog/2018/07/08/mark-sweep/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Mark and Sweep Algorithm</a> (Mainstream)</li>\n</ul>\n<p><img src=\"https://i.imgur.com/NUiwqfV.gif\"></p>\n<ul>\n<li>\n<p>Advantages of Mark and Sweep Algorithm</p>\n<ul>\n<li>It handles the case with cyclic references, even in case of a cycle, this algorithm never ends up in an infinite loop.</li>\n<li>There are no additional overheads incurred during the execution of the algorithm.</li>\n</ul>\n</li>\n<li>\n<p>Disadvantages of Mark and Sweep Algorithm</p>\n<ul>\n<li>The main disadvantage of the mark-and-sweep approach is the fact that that normal program execution is suspended while the garbage collection algorithm runs.</li>\n<li>Other disadvantage is that, after the Mark and Sweep Algorithm is run several times on a program, reachable objects end up being separated by many, small unused memory regions. Look at the below figure for better understanding.</li>\n</ul>\n<p><img src=\"https://i.imgur.com/P1GAEzC.png\"></p>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>🤔 <strong>Self-question</strong>\n<br>How to deal with memory <a href=\"https://en.wikipedia.org/wiki/Fragmentation_(computing)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fragmentation</a>?\n<br>Take a look for <a href=\"https://www.zhihu.com/question/51836333/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Memory paging.</a></p>\n</blockquote>","fields":{"slug":"/posts/cracking-javascript-series-javascript-engine","tagSlugs":["/tag/java-script/","/tag/ast/","/tag/compiler/","/tag/interpreter/","/tag/v-8/","/tag/call-stack/","/tag/memory-heap/"]},"frontmatter":{"date":"2020-03-16T18:32:18.151Z","description":"AST, Compiler, Interpreter, V8, Call Stack, and Memory Heap","tags":["JavaScript","AST","Compiler","Interpreter","V8","Call Stack","Memory Heap"],"title":"🥊 Cracking JavaScript Series: JavaScript Engine","socialImage":{"publicURL":"/static/74f1593e765ce853960c4c5b7b897fb8/javascript-engine-execution-steps.jpg"}}}},"pageContext":{"slug":"/posts/cracking-javascript-series-javascript-engine"}},"staticQueryHashes":["251939775","3983120721","401334301"]}